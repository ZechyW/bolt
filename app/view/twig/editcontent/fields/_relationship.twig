{#=== INIT ===========================================================================================================#}

{# We set the 'format' for the rendering of each <option>. With fallback to a sensible default. #}
{% set format = relation.format|default("{{ item.title|escape }} <span>(â„– {{ item.id }})</span>") %}

{#=== FIELDSET =======================================================================================================#}

{% extends '_base/_fieldset.twig' %}

{% block fieldset_type 'relationship' %}

{% block fieldset_label_text  relation.label|default(relcontenttype|ucfirst) %}
{% block fieldset_label_class 'col-sm-4' %}

{% block fieldset_controls %}
    <div class="col-sm-8">

        {% if relation.multiple is defined and relation.multiple == 1 %}
            <select name="relation[{{ relcontenttype }}][]" id="relation-{{ relcontenttype }}" class="wide" multiple style="width: 100%;" data-placeholder="{{ __('(none)') }}">
        {% else %}
            <select name="relation[{{ relcontenttype }}][]" id="relation-{{ relcontenttype }}" class="wide" style="width: 100%;" data-placeholder="{{ __('(none)') }}">
                <option value="0">{{ __('(none)') }}</option>
        {% endif %}

            {% set groupby = relation.groupby|default(false) %}
            {% set optgroup = '' %}
            {% for item in listcontent(relcontenttype, relation, context.content) %}
                {% if relcontenttype == app.request.get('relation') and item.id == app.request.get('relationid') %}
                    {% set selectedbyrelation = true %}
                {% else %}
                    {% set selectedbyrelation = false %}
                {% endif %}
                {% if groupby and optgroup != item[groupby] %}
                    {% if optgroup != '' %}</optgroup>{% endif %}
                    {% set optgroup = item[groupby] %}
                    <optgroup label="{{ optgroup }}">
                {% endif %}
                <option value="{{ item.id }}"{% if item.selected or selectedbyrelation %} selected{% endif %}>
                    {{ format|twig({'item': item}) }}
                </option>
            {% endfor %}
            {% if optgroup != '' %}</optgroup>{% endif %}

        </select>

        <script>
            $(function() {
                $('#relation-{{ relcontenttype }}').select2({
                    placeholder: "{{ __('(none)') }}",
                    allowClear: true
                    {% if groupby %}, formatSelection: function (item) {
                        return $(item.element).parent().attr('label') + ': ' + item.text;
                    }{% endif %}
                });
            });
        </script>
    </div>
{% endblock fieldset_controls %}
